#!/bin/sh

domain=""
phpsessid=""
rememberme=""
ebookpath=""
notify-send -u critical "Wallabag" "Script variables are not set."
exit 1

override_notify() {
    sub="$1"
    shift
    notify-send -h "string:x-canonical-private-synchronous:wallabag" $@ "Wallabag" "$sub"
}

# check if ebook exists before starting download
deviceinfo="$(lsblk | grep "1.2G")"
[ -z "$deviceinfo" ] && { override_notify "Ebook not connected." -u critical; exit 1; }
[ "$(echo "$deviceinfo" | wc -l)" != "1" ] && { override_notify "Multiple devices might be ebook, mount manually." -u critical; exit 1; }

# download new epub file
outfile=$(mktemp)
curl -s "https://$domain/export/unread.epub" \
    -H "cookie: PHPSESSID=$phpsessid; REMEMBERME=$rememberme" \
    -o "$outfile" \
    &
pid="$!"

override_notify "Downloading..." -t 0

# mount ebook and remove last entry if existent
udisksctl mount -b "/dev/${deviceinfo%% *}" || { override_notify "Error mounting ebook." -u critical; exit 1; }
rm -f $ebookpath/unread_articles_????-??-??.epub

override_notify "Downloading...\nEbook mounted." -t 0

# wait for download to finish
wait "$pid"

override_notify "Transferring files." -t 0

mv "$outfile" "$ebookpath/unread_articles_$(date +"%Y-%m-%d").epub"
udisksctl unmount -b "/dev/${deviceinfo%% *}" || { override_notify "Error unmounting ebook." -u critical; exit 1; }

override_notify "Finished successfully." -u low
